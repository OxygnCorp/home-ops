---
# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
name: Lint

on:
  pull_request:
    branches: ["main"]

concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  yamllint:
    name: Lint - yamllint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Run yamllint
        run: |
          pip install yamllint==1.38.0
          yamllint --config-file .yamllint.yaml kubernetes/

  kubeconform:
    name: Lint - kubeconform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Run kubeconform
        run: |
          curl -fsSL -o /tmp/kubeconform.tar.gz \
            "https://github.com/yannh/kubeconform/releases/download/v0.7.0/kubeconform-linux-amd64.tar.gz"
          tar xzf /tmp/kubeconform.tar.gz -C /usr/local/bin kubeconform
          find kubernetes/ -name "*.yaml" -not -path "*/templates/*" | \
            xargs kubeconform \
              -strict \
              -ignore-missing-schemas \
              -schema-location=default \
              "-schema-location=https://k8s-schemas.oxygn.dev/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json" \
              -output=text \
              -verbose

  success:
    if: ${{ !cancelled() }}
    needs: ["yamllint", "kubeconform"]
    name: Lint - Success
    runs-on: ubuntu-latest
    steps:
      - name: Any jobs failed?
        if: ${{ contains(needs.*.result, 'failure') }}
        run: exit 1

      - name: All jobs passed or skipped?
        if: ${{ !(contains(needs.*.result, 'failure')) }}
        run: echo "All jobs passed or skipped" && echo "${{ toJSON(needs.*.result) }}"
