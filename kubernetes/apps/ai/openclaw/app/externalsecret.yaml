---
# yaml-language-server: $schema=https://k8s-schemas.oxygn.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: openclaw
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: openclaw-secret
    template:
      engineVersion: v2
      data:
        ## Gateway token for authentication
        OPENCLAW_GATEWAY_TOKEN: "{{ .OPENCLAW_GATEWAY_TOKEN }}"
        ##Discord
        DISCORD_BOT_TOKEN: "{{ .DISCORD_BOT_TOKEN }}"
        ## Github Access
        GITHUB_APP_ID: "{{ .GITHUB_APP_ID }}"
        GITHUB_APP_INSTALLATION_ID: "{{ .GITHUB_APP_INSTALLATION_ID }}"
        GITHUB_APP_PRIVATE_KEY: |-
          {{ .GITHUB_APP_PRIVATE_KEY }}
        ## Google Access
        GOG_CLIENT_ID: "{{ .GOG_CLIENT_ID }}"
        GOG_CLIENT_SECRET: "{{ .GOG_CLIENT_SECRET }}"
        GOG_KEYRING_PASSWORD: "{{ .GOG_KEYRING_PASSWORD }}"
        GOG_ACCOUNT: "{{ .GOG_ACCOUNT }}"
        GOG_REFRESH_TOKEN: "{{ .GOG_REFRESH_TOKEN }}"
        GEMINI_API_KEY: "{{ .GEMINI_API_KEY }}"
        ## Todoist
        TODOIST_API_TOKEN: "{{ .TODOIST_API_TOKEN }}"
        ## 1password
        OP_SERVICE_ACCOUNT_TOKEN: "{{ .OP_SERVICE_ACCOUNT_TOKEN }}"
        ## Anthropic
        ANTHROPIC_API_KEY: "{{ .ANTHROPIC_API_KEY }}"
  dataFrom:
    - extract:
        key: openclaw
---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: &name openclaw-config
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: *name
    template:
      data:
        ## OpenClaw configuration file
        openclaw.json: |
          {
            "gateway": {
              "mode": "local",
              "auth": {
                "mode": "token",
                "token": "{{ .OPENCLAW_GATEWAY_TOKEN }}"
              },
              "http": {
                "endpoints": {
                  "chatCompletions": {
                    "enabled": true
                  }
                }
              },
              "port": 18789,
              "bind": "loopback",
              "tailscale": {
                "mode": "off",
                "resetOnExit": false
              },
              "trustedProxies": ["10.42.0.0/16", "10.10.0.0/16"]
            },
            "browser": {
              "enabled": true,
              "defaultProfile": "default",
              "profiles": {
                "default": {
                  "cdpUrl": "http://localhost:9222",
                  "color": "#4285F4"
                }
              }
            },
            "agents": {
              "defaults": {
                "model": {
                  "primary": "anthropic/claude-sonnet-4-6",
                  "fallbacks": [
                    "anthropic/claude-haiku-4-5",
                    "google/gemini-3-flash"
                  ]
                },
                "models": {
                  "anthropic/claude-opus-4-6": {
                    "alias": "opus",
                    "params": {
                      "cacheRetention": "long",
                      "effort": "high",
                      "adaptiveThinking": true,
                      "temperature": 1.0,
                      "maxOutputTokens": 8192
                    }
                  },
                  "anthropic/claude-sonnet-4-6": {
                    "alias": "sonnet",
                    "params": {
                      "cacheRetention": "long",
                      "adaptiveThinking": true,
                      "temperature": 1.0,
                      "compressionLevel": "high"
                    }
                  },
                  "anthropic/claude-haiku-4-5": {
                    "alias": "haiku",
                    "params": {
                      "cacheRetention": "short",
                      "temperature": 0.2,
                      "maxOutputTokens": 2048
                    }
                  },
                  "google/gemini-3-flash": {
                    "alias": "flash",
                    "params": {
                      "temperature": 1.0
                    }
                  }
                },
                "contextTokens": 128000,
                "contextPruning": {
                  "mode": "cache-ttl",
                  "ttl": "6h",
                  "keepLastAssistants": 4
                },
                "compaction": {
                  "mode": "default",
                  "memoryFlush": {
                    "enabled": true,
                    "softThresholdTokens": 10000,
                    "prompt": "Extract key decisions, state changes, lessons, blockers to memory/YYYY-MM-DD.md. Format: ## [HH:MM] Topic. Skip routine work. NO_FLUSH if nothing important.",
                    "systemPrompt": "Compacting session context. Extract only what's worth remembering. No fluff."
                  }
                },
                "userTimezone": "UTC+2",
                "timeoutSeconds": 600,
                "maxConcurrent": 1,
                "memorySearch": {
                  "provider": "gemini",
                  "model": "gemini-embedding-001",
                  "fallback": "local",
                  "local": {
                    "modelPath": "hf:ggml-org/embeddinggemma-300M-GGUF/embeddinggemma-300M-Q8_0.gguf"
                  },
                  "sync": {
                    "watch": true
                  },
                  "query": {
                    "hybrid": {
                      "enabled": true,
                      "vectorWeight": 0.7,
                      "textWeight": 0.3
                    }
                  }
                }
              },
              "list": [
                {
                  "id": "main",
                  "default": true,
                  "name": "Claw",
                  "identity": {
                    "name": "OpenClaw",
                    "emoji": "ü¶û"
                  },
                  heartbeat: { every: "30m" },
                  workspace: "/home/node/.openclaw/workspace",
                  agentDir: "/home/node/.openclaw/agents/main/agent"
                },
                {
                  "id": "devops",
                  "name": "DevOps SRE",
                  "workspace": "/home/node/.openclaw/workspace-devops",
                  "agentDir": "/home/node/.openclaw/agents/devops/agent",
                  "model": {
                    "primary": "anthropic/claude-sonnet-4-6",
                    "fallbacks": [
                      "anthropic/claude-haiku-4-5"
                    ]
                  },
                  "identity": {
                    "name": "DevOps Bot",
                    "emoji": "üõ†Ô∏è"
                  },
                  "groupChat": {
                    "mentionPatterns": ["@devops", "@sre"]
                  },
                  "tools": {
                    "allow": ["exec", "read", "sessions_spawn", "session_status", "gh-cli", "kubectl"]
                  }
                },
                {
                  "id": "family",
                  "name": "Family",
                  "workspace": "/home/node/.openclaw/workspace-family",
                  "agentDir": "/home/node/.openclaw/agents/family/agent",
                  "model": {
                    "primary": "google/gemini-3-flash",
                    "fallbacks": [
                      "anthropic/claude-haiku-4-5"
                    ]
                  },
                  "identity": {
                    "name": "Family Bot",
                    "emoji": "üè†"
                  },
                  "groupChat": {
                    "mentionPatterns": ["@family", "@familybot"]
                  },
                  "tools": {
                    "allow": ["read", "browser", "sessions_list"]
                  }
                },
                {
                  "id": "coach",
                  "name": "Mentor",
                  "workspace": "/home/node/.openclaw/workspace-coach",
                  "agentDir": "/home/node/.openclaw/agents/coach/agent",
                  "model": {
                    "primary": "anthropic/claude-opus-4-6",
                    "fallbacks": [
                      "anthropic/claude-sonnet-4-6"
                    ]
                  },
                  "identity": {
                    "name": "Coach",
                    "emoji": "üéì"
                  }
                }
              ]
            },
            "bindings": [
              {
                "agentId": "devops",
                "match": {
                  "channel": "discord",
                  "guildId": "{{ .DISCORD_GUILD_ID }}",
                  "peer": { "kind": "channel", "id": "{{ .DISCORD_DEVOPS_CHANNEL_ID }}" }
                }
              },
              {
                "agentId": "main",
                "match": {
                  "channel": "discord",
                  "guildId": "{{ .DISCORD_GUILD_ID }}",
                  "peer": { "kind": "channel", "id": "{{ .DISCORD_CLAW_CHANNEL_ID }}" }
                }
              }
            ],
            "session": {
              "dmScope": "per-channel-peer",
              "reset": {
                "mode": "idle",
                "idleMinutes": 60
              }
            },
            "logging": {
              "level": "trace",
              "consoleLevel": "trace",
              "consoleStyle": "compact",
              "redactSensitive": "tools"
            },
            "tools": {
              deny: ["web_search"],
              agentToAgent: {
                enabled: true,
                allow: ["main", "devops", "family", "coach"]
              }
            },
            "hooks": {
              "enabled": true,
              "path": "/webhooks",
              "token": "{{ .OPENCLAW_GITHUB_WEBHOOK_SECRET }}",
              "maxBodyBytes": 262144,
              "transformsDir": "/home/node/.openclaw/hooks/transforms",
              "mappings": [
                {
                  "id": "github-pr-notifications",
                  "match": {
                    "path": "github"
                  },
                  "action": "agent",
                  "agentId": "devops",
                  "wakeMode": "now",
                  "channel": "discord",
                  "to": "channel:{{ .DISCORD_DEVOPS_CHANNEL_ID }}",
                  "deliver": true,
                  "name": "GitHub PR Handler",
                  "transform": {
                    "module": "./github-webhook-transform.js"
                  }
                }
              ]
            },
            "plugins": {
              "entries": {
                "discord": {
                  "enabled": true
                }
              }
            },
            "channels": {
              "discord": {
                "enabled": true,
                "token": "{{ .DISCORD_BOT_TOKEN }}",
                "blockStreaming": true,
                "groupPolicy": "allowlist",
                "dmPolicy": "allowlist",
                "allowFrom": ["{{ .DISCORD_USER_ID }}"],
                "guilds": {
                  "{{ .DISCORD_GUILD_ID }}": {
                    "users": [
                      "{{ .DISCORD_USER_ID }}"
                    ],
                    "channels": {
                      "{{ .DISCORD_DEVOPS_CHANNEL_ID }}": {
                        "allow": true,
                        "requireMention": false,
                        "skills": ["search", "docs", "github"],
                        "systemPrompt": "Tu es l'expert DevOps. Priorise la s√©curit√© et la stabilit√© de l'infrastructure."
                      },
                      "{{ .DISCORD_CLAW_CHANNEL_ID }}": {
                        "allow": true,
                        "requireMention": false,
                        "skills": ["search", "docs"],
                        "systemPrompt": "Keep answers short."
                      }
                    }
                  }
                }
              }
            }
          }
  dataFrom:
    - extract:
        key: openclaw
