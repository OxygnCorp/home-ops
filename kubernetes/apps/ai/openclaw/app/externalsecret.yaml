---
# yaml-language-server: $schema=https://k8s-schemas.oxygn.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: openclaw
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: openclaw-secret
    template:
      engineVersion: v2
      data:
        ## Gateway token for authentication
        OPENCLAW_GATEWAY_TOKEN: "{{ .OPENCLAW_GATEWAY_TOKEN }}"
        ##Discord
        DISCORD_BOT_TOKEN: "{{ .DISCORD_BOT_TOKEN }}"
        ## Github Access
        GITHUB_APP_ID: "{{ .GITHUB_APP_ID }}"
        GITHUB_APP_INSTALLATION_ID: "{{ .GITHUB_APP_INSTALLATION_ID }}"
        GITHUB_APP_PRIVATE_KEY: |-
          {{ .GITHUB_APP_PRIVATE_KEY }}
        ## Google Access
        GOG_CLIENT_ID: "{{ .GOG_CLIENT_ID }}"
        GOG_CLIENT_SECRET: "{{ .GOG_CLIENT_SECRET }}"
        GOG_KEYRING_PASSWORD: "{{ .GOG_KEYRING_PASSWORD }}"
        GOG_ACCOUNT: "{{ .GOG_ACCOUNT }}"
        GOG_REFRESH_TOKEN: "{{ .GOG_REFRESH_TOKEN }}"
        GEMINI_API_KEY: "{{ .GEMINI_API_KEY }}"
        ## Todoist
        TODOIST_API_TOKEN: "{{ .TODOIST_API_TOKEN }}"
        ## 1password
        OP_SERVICE_ACCOUNT_TOKEN: "{{ .OP_SERVICE_ACCOUNT_TOKEN }}"
        ## Anthropic
        ANTHROPIC_API_KEY: "{{ .ANTHROPIC_API_KEY }}"
  dataFrom:
    - extract:
        key: openclaw
---
# yaml-language-server: $schema=https://kube-schemas.pages.dev/external-secrets.io/externalsecret_v1.json
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: &name openclaw-config
spec:
  secretStoreRef:
    kind: ClusterSecretStore
    name: onepassword
  target:
    name: *name
    template:
      data:
        ## OpenClaw configuration file
        openclaw.json: |
          {
            "gateway": {
              "mode": "local",
              "auth": {
                "mode": "token",
                "token": "{{ .OPENCLAW_GATEWAY_TOKEN }}"
              },
              "http": {
                "endpoints": {
                  "chatCompletions": {
                    "enabled": true
                  }
                }
              },
              "port": 18789,
              "bind": "loopback",
              "tailscale": {
                "mode": "off",
                "resetOnExit": false
              },
              "trustedProxies": ["10.42.0.0/16", "10.10.0.0/16"]
            },
            "browser": {
              "enabled": true,
              "defaultProfile": "default",
              "profiles": {
                "default": {
                  "cdpUrl": "http://localhost:9222",
                  "color": "#4285F4"
                }
              }
            },
            "agents": {
              "defaults": {
                "workspace": "/home/node/.openclaw/workspace",
                "model": {
                  "primary": "anthropic/claude-sonnet-4-5",
                  "fallbacks": [
                    "anthropic/claude-haiku-4-5",
                    "google/gemini-3-flash"
                  ]
                },
                "models": {
                  "anthropic/claude-opus-4-6": {
                    "alias": "opus",
                    "params": {
                      "cacheRetention": "long",
                      "effort": "high",
                      "adaptiveThinking": true
                    }
                  },
                  "anthropic/claude-sonnet-4-5": {
                    "alias": "sonnet",
                    "params": {
                      "cacheRetention": "long",
                      "temperature": 0.4
                    }
                  },
                  "anthropic/claude-haiku-4-5": {
                    "alias": "haiku",
                    "params": {
                      "cacheRetention": "short",
                      "temperature": 0.2,
                      "maxOutputTokens": 2048
                    }
                  },
                  "google/gemini-3-flash": {
                    "alias": "flash",
                    "params": {
                      "temperature": 1.0
                    }
                  }
                },
                "contextTokens": 128000,
                "compaction": "aggressive",
                "userTimezone": "UTC+2",
                "timeoutSeconds": 600,
                "maxConcurrent": 1,
                "memorySearch": {
                  "provider": "gemini",
                  "model": "gemini-embedding-001",
                  "fallback": "local",
                  "local": {
                    "modelPath": "hf:ggml-org/embeddinggemma-300M-GGUF/embeddinggemma-300M-Q8_0.gguf"
                  },
                  "sync": {
                    "watch": true
                  },
                  "query": {
                    "hybrid": {
                      "enabled": true,
                      "vectorWeight": 0.7,
                      "textWeight": 0.3
                    }
                  }
                }
              },
              "list": [
                {
                  "id": "main",
                  "default": true,
                  "identity": {
                    "name": "OpenClaw",
                    "emoji": "ü¶û"
                  },
                  heartbeat: { every: "30m" },
                  workspace: "/home/node/.openclaw/workspace",
                  agentDir: "/home/node/.openclaw/agents/main/agent"
                },
                {
                  "id": "devops",
                  "name": "DevOps SRE",
                  "workspace": "/home/node/.openclaw/workspace-devops",
                  "agentDir": "/home/node/.openclaw/agents/devops/agent",
                  "model": "anthropic/claude-sonnet-4-5",
                  "fallback": "anthropic/claude-haiku-4-5",
                  "identity": {
                    "name": "DevOps Bot",
                    "emoji": "üõ†Ô∏è"
                  },
                  "groupChat": {
                    "mentionPatterns": ["@devops", "@sre"]
                  },
                  "sandbox": {
                    "mode": "all",
                    "scope": "agent"
                  },
                  "tools": {
                    "allow": ["exec", "read", "sessions_spawn", "session_status", "gh-cli", "kubectl"]
                  },
                  "cron": [
                    {
                      "schedule": "0 * * * *",
                      "command": "Analyze new github PR, check for changes in code, detect risks or vulnerabilities, and monitor the health of the Kubernetes cluster. Post a synthetic report.",
                      "channel": "discord",
                      "to": "channel:1024230322398822470"
                    }
                  ]
                },
                {
                  "id": "family",
                  "name": "Family",
                  "workspace": "/home/node/.openclaw/workspace-family",
                  "agentDir": "/home/node/.openclaw/agents/family/agent",
                  "model": "google/gemini-3-flash",
                  "fallback": "anthropic/claude-haiku-4-5",
                  "identity": {
                    "name": "Family Bot",
                    "emoji": "üè†"
                  },
                  "groupChat": {
                    "mentionPatterns": ["@family", "@familybot"]
                  },
                  "sandbox": {
                    "mode": "restricted",
                    "scope": "agent"
                  },
                  "tools": {
                    "allow": ["read", "browser", "sessions_list"]
                  }
                },
                {
                  "id": "coach",
                  "name": "Mentor",
                  "workspace": "/home/node/.openclaw/workspace-coach",
                  "agentDir": "/home/node/.openclaw/agents/coach/agent",
                  "model": "anthropic/claude-opus-4-6",
                  "fallback": "anthropic/claude-sonnet-4-5",
                  "identity": {
                    "name": "Coach",
                    "emoji": "üéì"
                  }
                }
              ],
              "bindings": [
                {
                  "agentId": "devops",
                  "match": {
                    "channel": "discord",
                    "peer": { "kind": "channel", "id": "1024230322398822470" }
                  }
                }
              ]
            },
            "session": {
              "scope": "per-sender",
              "store": "/home/node/.openclaw/sessions",
              "reset": {
                "mode": "idle",
                "idleMinutes": 60
              }
            },
            "logging": {
              "level": "info",
              "consoleLevel": "info",
              "consoleStyle": "compact",
              "redactSensitive": "tools"
            },
            "tools": {
              deny: ["web_search"],
              agentToAgent: {
                enabled: true,
                allow: ["main", "devops", "family", "coach"]
              }
            },
            "hooks": {
              "enabled": true,
              "path": "/webhooks",
              "token": "{{ .OPENCLAW_GITHUB_WEBHOOK_SECRET }}",
              "maxBodyBytes": 262144,
              "transformsDir": "/home/node/.openclaw/workspace",
              "mappings": [
                {
                  "id": "github-pr-notifications",
                  "match": {
                    "path": "github"
                  },
                  "action": "agent",
                  "agentId": "devops",
                  "wakeMode": "now",
                  "channel": "discord",
                  "to": "channel:1024230322398822470",
                  "deliver": true,
                  "name": "GitHub PR Handler",
                  "transform": {
                    "module": "./hooks/github-webhook-transform.js"
                  }
                }
              ]
            },
            "plugins": {
              "entries": {
                "discord": {
                  "enabled": true
                }
              }
            },
            "channels": {
              "discord": {
                "enabled": true,
                "token": "{{ .DISCORD_BOT_TOKEN }}",
                "blockStreaming": true,
                "groupPolicy": "allowlist",
                "guilds": {
                  "{{ .DISCORD_GUILD_ID }}": {
                    "requireMention": false,
                    "channels": {
                      "1024230322398822470": {
                        "allow": true,
                        "skills": ["search", "docs"],
                        "systemPrompt": "Tu es l'expert DevOps. Priorise la s√©curit√© et la stabilit√© de l'infrastructure."
                      },
                      "{{ .DISCORD_CHANNEL_ID }}": {
                        "allow": true,
                        "requireMention": true,
                        "skills": ["search", "docs"],
                        "systemPrompt": "Keep answers short."
                      }
                    }
                  }
                },
                "dm": {
                  "enabled": false,
                  "policy": "allowlist",
                  "allowFrom": ["{{ .DISCORD_USER_ID }}"],
                  "groupEnabled": false
                }
              }
            }
          }
  dataFrom:
    - extract:
        key: openclaw
