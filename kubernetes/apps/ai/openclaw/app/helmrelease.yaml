---
# yaml-language-server: $schema=https://raw.githubusercontent.com/bjw-s-labs/helm-charts/main/charts/other/app-template/schemas/helmrelease-helm-v2.schema.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: openclaw
spec:
  chartRef:
    kind: OCIRepository
    name: openclaw
  interval: 1h
  values:
    controllers:
      openclaw:
        replicas: 1
        strategy: Recreate
        annotations:
          secret.reloader.stakater.com/reload: "openclaw-secret, openclaw-config"

        initContainers:
          # Init container handles config setup with merge/overwrite modes.
          # Uses OpenClaw image for Node.js runtime (required for merge mode).
          # Runs as root to chown files to app user (UID 1000).
          init-config:
            image:
              repository: ghcr.io/openclaw/openclaw
              tag: "2026.2.12"
            command:
              - sh
              - -c
              - |
                log() { echo "[$(date -Iseconds)] [init-config] $*"; }

                log "Starting config initialization"
                mkdir -p /home/node/.openclaw
                CONFIG_MODE="${CONFIG_MODE:-merge}"

                # Check if existing config file has valid JSON content
                EXISTING_VALID=false
                if [ -f /home/node/.openclaw/openclaw.json ] && [ -s /home/node/.openclaw/openclaw.json ]; then
                  log "Found existing config file"
                  if node -e "const fs = require('fs'); JSON.parse(fs.readFileSync('/home/node/.openclaw/openclaw.json', 'utf8'));" 2>/dev/null; then
                    EXISTING_VALID=true
                    log "Existing config is valid JSON"
                  else
                    log "Existing config file is invalid or empty, will overwrite"
                  fi
                else
                  log "No existing config file found, will create new one"
                fi

                if [ "$CONFIG_MODE" = "merge" ] && [ "$EXISTING_VALID" = "true" ]; then
                  log "Mode: merge - merging Helm config with existing config"
                  node -e "
                    const fs = require('fs');
                    try {
                      // Read and validate existing config
                      const existingContent = fs.readFileSync('/home/node/.openclaw/openclaw.json', 'utf8').trim();
                      if (!existingContent) {
                        console.error('Existing config file is empty');
                        process.exit(1);
                      }
                      const existing = JSON.parse(existingContent);

                      // Read and validate helm config
                      if (!fs.existsSync('/config/openclaw.json')) {
                        console.error('Helm config file does not exist at /config/openclaw.json');
                        process.exit(1);
                      }
                      const helmContent = fs.readFileSync('/config/openclaw.json', 'utf8').trim();
                      if (!helmContent) {
                        console.error('Helm config file is empty');
                        process.exit(1);
                      }
                      const helm = JSON.parse(helmContent);

                      const deepMerge = (target, source) => {
                        for (const key of Object.keys(source)) {
                          if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                            target[key] = target[key] || {};
                            deepMerge(target[key], source[key]);
                          } else {
                            target[key] = source[key];
                          }
                        }
                        return target;
                      };
                      const merged = deepMerge(existing, helm);
                      fs.writeFileSync('/home/node/.openclaw/openclaw.json', JSON.stringify(merged, null, 2));
                    } catch (error) {
                      console.error('Error during config merge:', error.message);
                      process.exit(1);
                    }
                  " || {
                    log "Config merge failed, falling back to overwrite mode"
                    cp /config/openclaw.json /home/node/.openclaw/openclaw.json
                  }
                  log "Config merged successfully"
                else
                  log "Mode: overwrite - copying Helm config (fresh install or overwrite mode)"
                  cp /config/openclaw.json /home/node/.openclaw/openclaw.json
                fi
                chown -R 1000:1000 /home/node/.openclaw
                log "Config initialization complete"

                log "Changing default shell to zsh for better interactive experience"
                usermod -s /home/node/.local/homebrew/bin/zsh node || log "Failed to change default shell, zsh may not be installed yet"
            env:
              - name: CONFIG_MODE
                value: "merge"
            securityContext:
              runAsUser: 0
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                  - ALL
                add:
                  - CHOWN
                  - DAC_OVERRIDE
                  - FOWNER

          # Install ClawHub skills and runtime dependencies (idempotent)
          # Skills are installed from https://clawhub.com
          init-skills:
            image:
              repository: node
              tag: "24@sha256:00e9195ebd49985a6da8921f419978d85dfe354589755192dc090425ce4da2f7"
            command:
              - sh
              - -c
              - |
                log() { echo "[$(date -Iseconds)] [init-skills] $*"; }

                # ============================================================
                # Runtime Dependencies
                # ============================================================
                # Some skills require additional runtimes (Python, Go, etc.)
                # Install them here so they persist across pod restarts.
                #
                set -e
                mkdir -p /home/node/.local/bin /home/node/.local/go

                log "Starting tool installation..."

                # Install gh CLI if not present on PVC
                if [ ! -f /home/node/.local/bin/gh ]; then
                  echo "Installing gh CLI..."
                  cd /tmp
                  curl -fsSL https://github.com/cli/cli/releases/download/v2.86.0/gh_2.86.0_linux_amd64.tar.gz -o gh.tar.gz
                  tar xzf gh.tar.gz
                  cp gh_2.86.0_linux_amd64/bin/gh /home/node/.local/bin/
                  rm -rf gh.tar.gz gh_2.86.0_linux_amd64
                fi

                # Install Go if not present on PVC
                if [ ! -f /home/node/.local/go/bin/go ]; then
                  log "Installing Go..."
                  cd /tmp
                  curl -fsSL https://go.dev/dl/go1.23.5.linux-amd64.tar.gz -o go.tar.gz
                  tar xzf go.tar.gz
                  mv go /home/node/.local/
                  rm -rf go.tar.gz
                fi

                # Install Homebrew if not present on PVC
                if [ ! -f /home/node/.local/homebrew/bin/brew ]; then
                  log "Installing Homebrew..."
                  export HOMEBREW_PREFIX=/home/node/.local/homebrew
                  export HOMEBREW_CELLAR=/home/node/.local/homebrew/Cellar
                  export HOMEBREW_REPOSITORY=/home/node/.local/homebrew
                  export PATH=/home/node/.local/bin:/home/node/.local/go/bin:/home/node/.local/homebrew/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
                  mkdir -p $HOMEBREW_PREFIX
                  cd /tmp
                  git clone --depth 1 https://github.com/Homebrew/brew $HOMEBREW_PREFIX
                fi

                # Check if pip is available (either standalone or via python3 -m pip)
                set +e  # Don't fail on pip errors
                if command -v pip3 >/dev/null 2>&1 || command -v pip >/dev/null 2>&1 || python3 -m pip --version >/dev/null 2>&1; then
                  log "pip is available"
                else
                  log "Installing pip..."
                  cd /tmp
                  curl -fsSL https://bootstrap.pypa.io/get-pip.py -o get-pip.py
                  python3 get-pip.py --user --no-warn-script-location --break-system-packages || \
                  python3 get-pip.py --user --no-warn-script-location || \
                  log "pip install skipped (use python3 -m pip instead)"
                  rm -f get-pip.py
                fi
                set -e  # Re-enable error checking

                # Install uv (Python package manager) for Python skills
                if [ ! -f /home/node/.local/bin/uv ]; then
                  log "Installing uv..."
                  curl -LsSf https://astral.sh/uv/install.sh | env UV_INSTALL_DIR=/home/node/.local/bin sh
                fi

                # Install zsh if not present on PVC
                set +e  # Don't fail on brew errors
                if [ ! -f /home/node/.local/homebrew/bin/zsh ]; then
                  log "Installing zsh..."
                  /home/node/.local/homebrew/bin/brew install zsh
                fi
                set -e # Re-enable error checking

                log "Tool installation complete"

                log "Starting skills initialization"

                # ============================================================
                # Skill Installation
                # ============================================================
                # Install skills from ClawHub (https://clawhub.com)
                # Add skill slugs to the list below to install them declaratively.
                mkdir -p ~/.openclaw/skills
                for skill in weather github obsidian summarize; do
                  if [ -n "$skill" ] && [ ! -d "skills/${skill##*/}" ]; then
                    log "Installing skill: $skill"
                    npx -y clawhub install "$skill" --no-input || true
                  else
                    log "Skill already installed: $skill"
                  fi
                done
                log "Skills initialization complete"
            securityContext:
              runAsUser: 1000
              runAsGroup: 1000
              runAsNonRoot: true
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                  - ALL

        containers:
          app:
            image:
              repository: ghcr.io/openclaw/openclaw
              tag: 2026.2.17@sha256:1f28ead56a68352c2bbbbd4fb45523a237f271dc3be827b073b9274986a2a829
            command:
              - /bin/sh
              - -c
              - |
                # Set up openclaw CLI symlink
                ln -sf /app/openclaw.mjs /home/node/.local/bin/openclaw

                # Configure npm to install locally
                npm config set prefix '~/.npm'

                # Start gateway
                exec node /app/dist/index.js gateway --bind lan --port 18789
            env:
              HOME: &homepath /home/node
              TERM: xterm-256color
              PATH: /home/node/.local/bin:/home/node/.local/go/bin:/home/node/.local/homebrew/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
              GOPATH: /home/node/go
              HOMEBREW_PREFIX: /home/node/.local/homebrew
              HOMEBREW_CELLAR: /home/node/.local/homebrew/Cellar
              HOMEBREW_REPOSITORY: /home/node/.local/homebrew
              UV_INSTALL_DIR: /home/node/.local/bin
              NODE_ENV: production
              OPENCLAW_CONFIG_DIR: /home/node/.openclaw
              TZ: &tz Europe/Paris
            envFrom:
              - secretRef:
                  name: "{{ .Release.Name }}-secret"
            probes:
              liveness:
                enabled: true
                type: TCP
                spec:
                  tcpSocket:
                    port: &port 18789
                  initialDelaySeconds: 30
                  periodSeconds: 30
                  timeoutSeconds: 5
                  failureThreshold: 3
              readiness:
                enabled: true
                type: TCP
                spec:
                  tcpSocket:
                    port: *port
                  initialDelaySeconds: 10
                  periodSeconds: 10
                  timeoutSeconds: 5
                  failureThreshold: 3
              startup:
                enabled: true
                type: TCP
                spec:
                  tcpSocket:
                    port: *port
                  initialDelaySeconds: 5
                  periodSeconds: 5
                  timeoutSeconds: 5
                  failureThreshold: 30
            securityContext:
              runAsUser: 1000
              runAsGroup: 1000
              runAsNonRoot: true
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                  - ALL
            resources:
              requests:
                cpu: 100m
                memory: 512Mi
              limits:
                memory: 2Gi

          # -- Chromium sidecar for browser automation (CDP on port 9222)
          chromium:
            image:
              # -- Chromium image repository
              repository: zenika/alpine-chrome
              # -- Chromium image tag
              tag: "124@sha256:54a0e0cbe20d30f6f36485ff23a22985022cddaf6172789f82ae2d7457daa63a"
            command:
              - chromium-browser
            args:
              - --headless
              - --disable-gpu
              - --no-sandbox
              - --disable-dev-shm-usage
              - --remote-debugging-address=0.0.0.0
              - --remote-debugging-port=9222
              # Stealth flags to reduce bot detection
              - --disable-blink-features=AutomationControlled
              - --user-agent=Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/124.0.0.0 Safari/537.36
            env:
              TZ: *tz
            securityContext:
              runAsUser: 1000
              runAsGroup: 1000
              runAsNonRoot: true
              allowPrivilegeEscalation: false
              capabilities:
                drop:
                  - ALL
            resources:
              requests:
                cpu: 100m
                memory: 256Mi
              limits:
                cpu: 1000m
                memory: 1Gi
            probes:
              readiness:
                enabled: true
                type: TCP
                spec:
                  tcpSocket:
                    port: 9222
                  initialDelaySeconds: 5
                  periodSeconds: 10
          codeserver:
            image:
              repository: ghcr.io/coder/code-server
              tag: 4.109.2@sha256:1b84cd817fe8eb1159323ae9d2f29b3c70c6ccd44958d651a94900cf7f0ff9c4
            env:
              TZ: *tz
            args:
              [
                "--auth",
                "none",
                "--user-data-dir",
                "/home/node/.vscode",
                "--extensions-dir",
                "/home/node/.vscode",
                "--port",
                "12321",
                "/home/node/.openclaw",
              ]
            resources:
              requests:
                cpu: 10m
              limits:
                memory: 1Gi
    defaultPodOptions:
      shareProcessNamespace: true
      securityContext:
        fsGroup: 100
        fsGroupChangePolicy: OnRootMismatch

    service:
      main:
        ipFamilyPolicy: SingleStack
        ipFamilies:
          - IPv4
        ports:
          http:
            port: *port
          codeserver:
            port: &codeserverPort 12321
    route:
      main:
        hostnames:
          - "{{ .Release.Name }}.oxygn.dev"
          - "claw.oxygn.dev"
        parentRefs:
          - name: envoy-internal
            namespace: network
        rules:
          - backendRefs:
              - name: "{{ .Release.Name }}"
                port: *port
      codeserver:
        hostnames:
          - "openclaw-code.oxygn.dev"
          - "claw-code.oxygn.dev"
        parentRefs:
          - name: envoy-internal
            namespace: network
        rules:
          - backendRefs:
              - name: "{{ .Release.Name }}"
                port: *codeserverPort
    rbac:
      roles:
        openclaw-read-all:
          type: ClusterRole
          rules:
            - apiGroups: [""]
              resources: ["pods", "nodes", "services", "namespaces", "configmaps", "persistentvolumes", "persistentvolumeclaims", "endpoints", "resourcequotas", "limitranges", "serviceaccounts", "events"]  # Added events
              verbs: ["get", "list", "watch"]
            - apiGroups: [""]
              resources: ["pods/log"]
              verbs: ["get", "list"]
            - apiGroups: ["apps"]
              resources: ["deployments", "daemonsets", "statefulsets", "replicasets"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["batch"]
              resources: ["jobs", "cronjobs"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["networking.k8s.io"]
              resources: ["ingresses", "networkpolicies"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["storage.k8s.io"]
              resources: ["storageclasses"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["rbac.authorization.k8s.io"]
              resources: ["roles", "rolebindings", "clusterroles", "clusterrolebindings"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["metrics.k8s.io"]
              resources: ["nodes", "pods"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["helm.toolkit.fluxcd.io"]
              resources: ["helmreleases"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["kustomize.toolkit.fluxcd.io"]
              resources: ["kustomizations"]
              verbs: ["get", "list", "watch"]
            - apiGroups: ["external-secrets.io"]
              resources: ["externalsecrets"]
              verbs: ["get", "list", "watch"]
        openclaw-write-restricted:
          type: Role
          rules:
            - apiGroups: [""]
              resources: ["pods"]
              verbs: ["delete"]
            - apiGroups: ["apps"]
              resources: ["deployments"]
              verbs: ["patch", "update"]
      bindings:
        openclaw-read-all:
          type: ClusterRoleBinding
          roleRef:
            identifier: openclaw-read-all
          subjects:
            - identifier: openclaw
              serviceAccount: openclaw
        openclaw-write-restricted:
          type: RoleBinding
          roleRef:
            identifier: openclaw-write-restricted
          subjects:
            - identifier: openclaw
              serviceAccount: openclaw
    serviceAccount:
      openclaw: {}
    persistence:
      config:
        existingClaim: "{{ .Release.Name }}"
        globalMounts:
          - path: *homepath
      openclaw-config:
        type: secret
        name: "{{ .Release.Name }}-config"
        globalMounts:
          - path: /config/openclaw.json
            subPath: openclaw.json
      documents:
        type: nfs
        server: funkstation.internal
        path: /volume2/Documents
        globalMounts:
          - path: /documents
      tmp:
        type: emptyDir
